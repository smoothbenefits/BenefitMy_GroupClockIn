timeTrackingApp.factory("faceRecognitionService",["$http","$q","userModel","localStorageService","timeTrackingService","companyModel","ENV_VARS",function(e,t,n,o,r,a,c){function i(e){for(var t=atob(e.split(",")[1]),n=[],o=0;o<t.length;o++)n.push(t.charCodeAt(o));return new Blob([new Uint8Array(n)],{type:"image/jpeg"})}function u(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}AWS.config.update({accessKeyId:c.AWSAccessKeyId,secretAccessKey:c.AWSSecretAccessKey}),AWS.config.region="us-east-1";var s=new AWS.Rekognition,g=new AWS.S3({params:{Bucket:c.IMAGE_S3_BUCKET}});return{uploadImage:function(e){var n=i(e),o={Key:u(),Body:n,ContentType:"image/jpeg"},r=t.defer();return g.upload(o,function(e,t){e||r.resolve(t)}),r.promise},uploadGoldenPicture:function(o){this.uploadImage(o).then(function(o){var i=t.defer(),u=o.Location,s=n.getUserProfile();return s.photo_url=u,s.manager=s.manager.id,s.person=s.person.id,s.company=a.getCompanyID(),e({url:c.StageBASEURL+n.getUserID(),method:"PUT",data:s,headers:{"Content-Type":"application/json"}}).then(function(e){console.log(e),n.setCurrentUser(e.data),r.clockIn(u),i.resolve(e)},function(e){i.reject(e),console.log(e)}),i.promise})},getRecognitionResult:function(e){var o=t.defer();this.uploadImage(e).then(function(e){var t=e.Location,r={SimilarityThreshold:1,SourceImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:n.getGoldenPhotoID()}},TargetImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:e.key}}};s.compareFaces(r,function(e,n){e?o.reject(e):o.resolve({url:t,confidence:n.FaceMatches[0].Similarity})})});return o.promise}}}]);