timeTrackingApp.factory("faceRecognitionService",["$http","$q","userModel","localStorageService","timeTrackingService","companyModel","ENV_VARS",function(e,t,o,n,r,a,c){function i(e){for(var t=atob(e.split(",")[1]),o=[],n=0;n<t.length;n++)o.push(t.charCodeAt(n));return new Blob([new Uint8Array(o)],{type:"image/jpeg"})}function u(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?o:3&o|8).toString(16)})}AWS.config.update({accessKeyId:c.AWSAccessKeyId,secretAccessKey:c.AWSSecretAccessKey}),AWS.config.region="us-east-1";var s=new AWS.Rekognition,l=new AWS.S3({params:{Bucket:c.IMAGE_S3_BUCKET}});return{uploadImage:function(e){var o=i(e),n={Key:u(),Body:o,ContentType:"image/jpeg"},r=t.defer();return l.upload(n,function(e,t){e||r.resolve(t)}),r.promise},uploadGoldenPicture:function(n){this.uploadImage(n).then(function(n){var i=t.defer(),u=n.Location;return e({url:c.StageBASEURL+o.getUserID(),method:"PUT",data:{photo_url:u,person:o.getUserID(),company:a.getCompanyID()},headers:{"Content-Type":"application/json"}}).then(function(e){console.log(e),o.setCurrentUser(e.data),r.clockIn(u),i.resolve(e)},function(e){i.reject(e),console.log(e)}),i.promise})},getRecognitionResult:function(e){var n=t.defer();this.uploadImage(e).then(function(e){var t=e.Location,r={SimilarityThreshold:1,SourceImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:o.getGoldenPhotoID()}},TargetImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:e.key}}};s.compareFaces(r,function(e,o){e?n.reject(e):n.resolve({url:t,confidence:o.FaceMatches[0].Similarity})})});return n.promise}}}]);