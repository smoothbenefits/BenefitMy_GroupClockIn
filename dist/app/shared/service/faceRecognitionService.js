timeTrackingApp.factory("faceRecognitionService",["$http","$q","userModel","localStorageService","timeTrackingService","companyModel","ENV_VARS",function(e,o,t,n,r,a,c){function i(e){for(var o=atob(e.split(",")[1]),t=[],n=0;n<o.length;n++)t.push(o.charCodeAt(n));return new Blob([new Uint8Array(t)],{type:"image/jpeg"})}function u(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(o){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===o?t:3&t|8).toString(16)})}AWS.config.update({accessKeyId:c.AWSAccessKeyId,secretAccessKey:c.AWSSecretAccessKey}),AWS.config.region="us-east-1";var s=new AWS.Rekognition,l=new AWS.S3({params:{Bucket:c.IMAGE_S3_BUCKET}});return{uploadImage:function(e){var t=i(e),n={Key:u(),Body:t,ContentType:"image/jpeg"},r=o.defer();return l.upload(n,function(e,o){e?(r.reject(e),console.log(e)):r.resolve(o)}),r.promise},uploadGoldenPicture:function(n){this.uploadImage(n).then(function(n){var i=o.defer(),u=n.Location,s=t.getUserProfile();return s.photo_url=u,s.manager=s.manager.id,s.person=s.person.id,s.company=a.getCompanyID(),r.punchTime(n),e({url:c.BASEURL+"employee_profile/"+t.getUserID(),method:"PUT",data:s,headers:{"Content-Type":"application/json"}}).then(function(e){console.log(e),t.setCurrentUser(e.data),i.resolve(e)},function(e){i.reject(e),console.log(e)}),i.promise})},getRecognitionResult:function(e){var n=o.defer();this.uploadImage(e).then(function(e){var o=e.Location,r={SimilarityThreshold:1,SourceImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:t.getGoldenPhotoID()}},TargetImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:e.key}}};s.compareFaces(r,function(e,t){e?n.reject(e):n.resolve({url:o,confidence:t.FaceMatches[0].Similarity})})});return n.promise}}}]);