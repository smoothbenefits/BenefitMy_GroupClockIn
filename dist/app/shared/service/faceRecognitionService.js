timeTrackingApp.factory("faceRecognitionService",["$http","$q","userModel","localStorageService","timeTrackingService","companyModel","ENV_VARS",function(e,n,o,t,r,a,c){function i(e){for(var n=atob(e.split(",")[1]),o=[],t=0;t<n.length;t++)o.push(n.charCodeAt(t));return new Blob([new Uint8Array(o)],{type:"image/jpeg"})}function l(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var o=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===n?o:3&o|8).toString(16)})}AWS.config.update({accessKeyId:c.AWSAccessKeyId,secretAccessKey:c.AWSSecretAccessKey}),AWS.config.region="us-east-1";var u=new AWS.Rekognition,s=new AWS.S3({params:{Bucket:c.IMAGE_S3_BUCKET}});return{uploadImage:function(e){var o=i(e),t={Key:l(),Body:o,ContentType:"image/jpeg"},r=n.defer();return s.upload(t,function(e,n){e?(r.reject(e),console.log(e)):r.resolve(n)}),r.promise},uploadGoldenPicture:function(t){var i=n.defer();this.uploadImage(t).then(function(n){var t=n.Location,l=o.getUserProfile();l.photo_url=t,l.person=l.person.id,l.company=a.getCompanyID(),null!==l.manager&&l.manager.hasOwnProperty("id")?l.manager=l.manager.id:l.manager=null,r.punchTime(n),e({url:c.BASEURL+"employee_profile/"+o.getUserID(),method:"PUT",data:l,headers:{"Content-Type":"application/json"}}).then(function(e){console.log(e),o.setCurrentUser(e.data),i.resolve(e)},function(e){i.reject(e),console.log(e)})},function(e){i.reject(e),console.log(e)});return i.promise},getRecognitionResult:function(e){var t=n.defer();this.uploadImage(e).then(function(e){var n=e.Location,r={SimilarityThreshold:1,SourceImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:o.getGoldenPhotoID()}},TargetImage:{S3Object:{Bucket:c.IMAGE_S3_BUCKET,Name:e.key}}};u.compareFaces(r,function(e,o){e?t.resolve({url:n,confidence:null}):t.resolve({url:n,confidence:o.FaceMatches[0].Similarity})})});return t.promise}}}]);